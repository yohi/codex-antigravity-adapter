# 実装計画: OpenAI Passthrough

## 概要

OpenAI Passthrough ルーターは、モデル名に基づいて Antigravity または上位サーバー(OpenAI API 等)にリクエストを自動で振り分ける機能を提供します。クライアントは単一のエンドポイント設定で複数のプロバイダーのモデルをシームレスに利用できます。

**新機能**:
- **Auth Passthrough モード**: `OPENAI_API_KEY` 未設定時、クライアントの認証情報を上位サーバーへ転送
- **カスタマイズ可能な接続先**: `OPENAI_BASE_URL` 環境変数で接続先を指定可能

---

## タスク

- [x] 1. 環境設定管理機能の構築
- [x] 1.1 OpenAI 環境変数の読み込みと提供機能を実装
  - API キーの読み込みと提供機能を実装
  - 接続先 URL の読み込みと提供機能を実装(デフォルト値: `https://api.openai.com`)
  - 設定状態の判定機能を提供(Server Auth モードまたは Auth Passthrough モード)
  - Base URL の取得機能を提供
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 2. 上位サーバーとの通信機能の実装
- [x] 2.1 リクエスト転送の基盤を構築
  - 上位サーバーへのリクエスト送信機能を実装
  - 標準 HTTP クライアント機能を使用した通信処理を実装
  - 接続先を設定サービスから動的に取得
  - タイムアウト制御機能を実装(デフォルト: 60秒)
  - リクエストボディを変換せずそのまま転送する処理を実装
  - _Requirements: 3.1, 3.4_

- [x] 2.2 認証ヘッダーの動的処理機能を実装
  - Server Auth モード時: サーバー側 API キーで認証ヘッダーを上書き
  - Auth Passthrough モード時: クライアントの認証ヘッダーをそのまま転送
  - 転送不要なヘッダーを除外する処理を実装
  - クライアントの追加ヘッダーを保持して転送する処理を実装
  - _Requirements: 1.2, 1.5, 3.2_

- [x] 2.3 ストリーミング応答の透過中継機能を実装
  - 上位サーバーからのストリーム応答を逐次中継する処理を実装
  - ストリームをバッファリングせず直接転送する機能を実装
  - ストリーム開始前のエラー検出と処理を実装
  - _Requirements: 3.3_

- [x] 2.4 エラー処理とレスポンス正規化機能を実装
  - 上位サーバーエラーの透過的な返却処理を実装（Req 4.1）
  - ネットワーク接続失敗時の 502 Bad Gateway エラーレスポンス生成（Req 4.2）
  - レスポンスボディ不正時の 502 Bad Gateway エラーレスポンス生成（Req 4.3）
  - 予期しない例外発生時の 500 Internal Server Error レスポンス生成（Req 4.4）
  - OpenAI 互換エラー形式の生成機能を実装
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 3. モデル名に基づくルーティング機能の実装
- [x] 3.1 モデル種別判定ロジックを実装
  - Gemini または Claude モデルの識別機能を実装
  - それ以外のモデルの識別機能を実装
  - 大文字小文字を区別しない判定処理を実装
  - 純粋関数として実装(副作用なし、同じ入力には同じ出力)
  - _Requirements: 2.1, 2.2_

- [ ] 3.2 リクエスト分岐処理をルーターに統合
  - チャット補完エンドポイントに分岐ロジックを追加
  - モデルエイリアス解決後にルーティング判定を実行
  - モデル指定の厳密な検証を実装(欠損、null、空文字列を検出)
  - モデル指定不正時の標準エラーレスポンス返却
  - パススルーサービス未設定時の内部エラー返却
  - Auth Passthrough モード時も正常にリクエスト転送
  - Antigravity ルートの既存処理フローを維持
  - _Requirements: 2.1, 2.2, 2.3, 5.1, 5.2, 5.3_

- [ ] 4. アプリケーション起動時の初期化処理を拡張
- [ ] 4.1 新規サービスの初期化とワイアリングを実装
  - 設定サービスの初期化処理を追加
  - パススルーサービスへの依存性注入を実装
  - ルーターへのパススルーサービス提供を実装
  - アプリケーションコンテキストへの新規サービス追加
  - 設定モードに応じた起動ログ出力を実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 5.3_

- [ ] 5. テストスイートの実装
- [ ] 5.1 ユニットテストを実装
  - モデル種別判定ロジックのテスト(各パターンで正しい振り分けを確認)
  - 環境設定管理機能のテスト(環境変数設定/未設定時の動作確認)
  - Base URL デフォルト値のテスト
  - エラーレスポンス生成機能のテスト(OpenAI 互換形式の正確性を確認)
  - ヘッダー処理ロジックのテスト(Auth Passthrough モード: API キー設定/未設定時の認証ヘッダー処理確認)
  - ヘッダー除外・保持処理のテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 3.2, 4.1, 4.2, 4.3, 4.4_

- [ ] 5.2 統合テストを実装
  - Antigravity ルートの動作確認テスト(Gemini/Claude モデルが既存サービスに流れることを確認)
  - 上位サーバールートの動作確認テスト(GPT モデルがパススルーサービスに流れることを確認)
  - Auth Passthrough モードの動作確認テスト(API キー未設定時、クライアント認証情報が転送されることを確認)
  - 既存機能の回帰テスト(モデルエイリアス解決が維持されることを確認)
  - _Requirements: 1.2, 1.5, 2.1, 2.2, 5.1, 5.2, 5.3_

- [ ] 5.3 E2E テストを実装(環境変数 `RUN_E2E=1` で有効化)
  - 実際の上位サーバー API との統合動作テスト
  - ストリーミング応答の完全な中継テスト
  - ストリーム開始前のエラー検出テスト
  - ストリーム完了通知の受信確認テスト
  - 無効な認証情報での上流エラー透過テスト（Req 4.1）
  - ネットワーク接続失敗でのエラー応答テスト（Req 4.2）
  - 不正なレスポンスボディでのエラー応答テスト（Req 4.3）
  - _Requirements: 3.3, 4.1, 4.2, 4.3_

---

## 要件カバレッジマトリックス

| 要件 ID | 概要 | 対応タスク |
|---------|------|-----------|
| 1.1 | 環境変数 `OPENAI_API_KEY` の使用 | 1.1, 4.1, 5.1 |
| 1.2 | Auth Passthrough モード(API キー未設定時、クライアント認証情報転送) | 1.1, 2.2, 3.2, 4.1, 5.1, 5.2 |
| 1.3 | 環境変数 `OPENAI_BASE_URL` の使用 | 1.1, 4.1, 5.1 |
| 1.4 | `OPENAI_BASE_URL` 未設定時のデフォルト値 (`https://api.openai.com`) | 1.1, 5.1 |
| 1.5 | `OPENAI_API_KEY` 設定時、クライアント認証ヘッダーを無視 | 2.2, 5.2 |
| 2.1 | Gemini/Claude モデルは Antigravity へ | 3.1, 3.2, 5.1, 5.2 |
| 2.2 | その他のモデルは上位サーバーへ | 3.1, 3.2, 5.1, 5.2 |
| 2.3 | モデル指定欠損時の 400 エラー | 3.2, 5.1 |
| 3.1 | スキーマ変換なしで転送 | 2.1 |
| 3.2 | ヘッダー処理(認証ヘッダー条件分岐、その他保持) | 2.2, 5.1 |
| 3.3 | ストリーミング応答の逐次中継 | 2.3, 5.3 |
| 3.4 | 上位サーバーからのレスポンスをそのまま返却 | 2.1 |
| 4.1 | 上流エラーの透過的な返却(Auth Passthrough モードでは上位サーバーの 401 を含む) | 2.4, 5.3 |
| 4.2 | 上流サービスへの接続失敗時の 502 Bad Gateway エラー | 2.4, 5.1, 5.3 |
| 4.3 | 上流からの不正なレスポンスボディ時の 502 Bad Gateway エラー | 2.4, 5.1 |
| 4.4 | 予期しない例外・内部エラー時の 500 Internal Server Error | 2.4, 5.1 |
| 5.1 | `/v1/chat/completions` エンドポイントの維持 | 3.2, 5.2 |
| 5.2 | モデル名に応じた自動経路選択 | 3.1, 3.2, 5.2 |
| 5.3 | 追加設定不要 | 3.2, 4.1, 5.2 |

---

## 実装の優先順位

1. **フェーズ 1: 設定基盤** (タスク 1.1)
   - `OPENAI_API_KEY` / `OPENAI_BASE_URL` 環境変数管理

2. **フェーズ 2: コア実装** (タスク 2.1, 2.2, 2.3, 2.4, 3.1)
   - パススルーサービス、Auth Passthrough、ルーティングロジック

3. **フェーズ 3: 統合** (タスク 3.2, 4.1)
   - ルーター拡張、サービス初期化とワイアリング

4. **フェーズ 4: 検証** (タスク 5.1, 5.2, 5.3)
   - ユニットテスト、統合テスト、E2E テスト

---

## 技術的な注意事項

### 既存コンポーネントとの連携
- **モデルルーティングサービス**: エイリアス解決は既存フローを維持
- **変換サービス**: Antigravity ルートは既存の変換処理を使用
- **プロキシルーター**: 分岐ロジックを追加、既存フローへの影響を最小化

### Auth Passthrough モードの仕様
- **モード判定**: API キー設定が未提供の場合に Auth Passthrough モードとなる
- **動作**: クライアントの認証情報をそのまま上位サーバーへ転送
- **エラー処理**: Auth Passthrough モードでクライアントの認証が無効な場合、上位サーバーからのエラー応答がそのままクライアントに返される

### セキュリティ
- サーバー側の API キーは環境変数から読み込み、ログに出力しない
- Auth Passthrough モードでは、クライアントが自身の認証情報を管理する責任を負う
- レスポンスへの API キー露出を防止

### テスト戦略
- **ユニットテスト**: 各機能の単体動作確認
- **統合テスト**: コンポーネント間の連携確認、既存機能の回帰確認
- **E2E テスト**: 実際の上位サーバー API との動作確認(環境変数で制御)
