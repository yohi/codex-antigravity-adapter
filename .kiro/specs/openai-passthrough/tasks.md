# 実装計画: OpenAI Passthrough

## 概要

OpenAI Passthrough ルーターは、モデル名に基づいて Antigravity または OpenAI API にリクエストを自動で振り分ける機能を提供します。クライアントは単一のエンドポイント設定で複数のプロバイダーのモデルをシームレスに利用できます。

---

## タスク

- [ ] 1. 設定サービスの実装
- [ ] 1.1 OpenAI API キー管理機能の実装
  - 環境変数 `OPENAI_API_KEY` からキーを読み込む機能を実装
  - キーの存在チェック機能を提供
  - サービスの初期化状態を確認するインターフェースを実装
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 2. OpenAI パススルーサービスの実装
- [ ] 2.1 OpenAI API との通信基盤を構築
  - OpenAI API エンドポイントへのリクエスト送信機能を実装
  - 標準 `fetch` API を使用した HTTP クライアントロジックを実装
  - タイムアウト設定と信号制御を実装
  - リクエストボディをスキーマ変換せずに転送する処理を実装
  - _Requirements: 3.1, 3.4_

- [ ] 2.2 ヘッダー処理ロジックの実装
  - クライアントの `Authorization` ヘッダーを無視し、サーバー側 API キーで上書きする処理を実装
  - `Host` と `Content-Length` ヘッダーを除外する処理を実装
  - その他のクライアントヘッダーを保持して転送する処理を実装
  - _Requirements: 3.2_

- [ ] 2.3 ストリーミング応答の透過中継機能を実装
  - OpenAI からの SSE ストリームを逐次中継する処理を実装
  - `ReadableStream` をそのまま返却する機能を実装
  - ストリーム開始前のエラー検出と処理を実装
  - _Requirements: 3.3_

- [ ] 2.4 エラーハンドリング機能の実装
  - API キー未設定時の 401 エラーレスポンスを生成
  - ネットワークエラー・タイムアウト時の 504 エラーレスポンスを生成
  - 予期しない例外発生時の 500 エラーレスポンスを生成
  - OpenAI からの不完全な応答を正規化したエラーレスポンスを生成
  - OpenAI 上流エラーをそのまま透過的に返却する処理を実装
  - OpenAI 互換エラー形式 (`error.message`, `error.type`, `error.param`, `error.code`) を生成するヘルパー関数を実装
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 3. ルーティングロジックの実装
- [ ] 3.1 モデル名に基づく振り分け判定機能を実装
  - モデル名に "gemini" または "claude" が含まれる場合、Antigravity ルートと判定
  - それ以外のモデル名を OpenAI ルートと判定
  - 純粋関数として実装（副作用なし）
  - _Requirements: 2.1, 2.2_

- [ ] 3.2 Router レイヤーに分岐ロジックを統合
  - `POST /v1/chat/completions` ハンドラーに分岐ロジックを追加
  - エイリアス解決（`ModelRoutingService`）後にルーティング判定を実行
  - `model` フィールドの厳密なバリデーションを実装（欠損、null、空文字列を検出）
  - `model` フィールドが不正な場合、要件通りのエラーメッセージとステータス 400 を返却
  - OpenAI ルート選択時に `OpenAIPassthroughService` が未設定の場合は内部エラーを返却
  - OpenAI ルート選択時に API キーが未設定の場合は 401 エラーを返却
  - Antigravity ルートは既存の `TransformService` フローを維持
  - _Requirements: 2.1, 2.2, 2.3, 5.1, 5.2, 5.3_

- [ ] 4. サービス初期化とワイアリング
- [ ] 4.1 main.ts のサービス初期化処理を拡張
  - `createAppContext` に設定サービスの初期化を追加
  - 設定サービスを依存性として OpenAI パススルーサービスに注入
  - `CreateProxyAppOptions` に `openaiService` オプションを追加
  - `AppContext` に新規サービスを追加
  - 設定状態に応じたログ出力を実装（INFO/DEBUG レベル）
  - _Requirements: 1.1, 1.2, 1.3, 5.3_

- [ ] 5. テストの実装
- [ ] 5.1 ユニットテストの実装
  - モデル名判定ロジックのテスト（各パターンで正しい振り分けを確認）
  - 設定サービスのテスト（環境変数設定/未設定時の動作を確認）
  - エラーレスポンス生成ヘルパーのテスト（OpenAI 互換形式の正確性を確認）
  - ヘッダー処理ロジックのテスト（Authorization 上書き、Host 除外、その他保持を確認）
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 3.2, 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 5.2 統合テストの実装
  - Antigravity ルートのテスト（gemini/claude モデルが TransformService に流れることを確認）
  - OpenAI ルートのテスト（gpt モデルが OpenAIPassthroughService に流れることを確認）
  - API キー未設定時の 401 エラーレスポンスを確認
  - 既存機能の回帰テスト（ModelRoutingService によるエイリアス解決が維持されることを確認）
  - _Requirements: 2.1, 2.2, 4.1, 5.1, 5.2, 5.3_

- [ ] 5.3 E2E テストの実装（`RUN_E2E=1` で有効化）
  - 実際の OpenAI API へのリクエスト/レスポンステスト
  - ストリーミング応答の透過中継テスト（SSE ストリームの完全性を確認）
  - ストリーム開始前のタイムアウトエラー検出テスト
  - 無効な API キーでの 401 パススルーテスト
  - ネットワークタイムアウトでの 504 エラーテスト
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.2, 4.3_

---

## 要件カバレッジマトリックス

| 要件 ID | 概要 | 対応タスク |
|---------|------|-----------|
| 1.1 | 環境変数 `OPENAI_API_KEY` の使用 | 1.1, 4.1, 5.1 |
| 1.2 | API キー未設定時の 401 エラー | 1.1, 2.4, 3.2, 5.1, 5.2 |
| 1.3 | クライアントに API キーを要求しない | 1.1, 4.1, 5.1 |
| 2.1 | gemini/claude モデルは Antigravity へ | 3.1, 3.2, 5.1, 5.2 |
| 2.2 | その他のモデルは OpenAI へ | 3.1, 3.2, 5.1, 5.2 |
| 2.3 | model フィールド欠損時の 400 エラー | 3.2, 5.1 |
| 3.1 | スキーマ変換なしで転送 | 2.1, 5.3 |
| 3.2 | ヘッダー処理（Authorization 上書き、その他保持） | 2.2, 5.1, 5.3 |
| 3.3 | ストリーミング応答の逐次中継 | 2.3, 5.3 |
| 3.4 | OpenAI からのレスポンスをそのまま返却 | 2.1, 5.3 |
| 4.1 | API キー未設定時の 401 エラー | 2.4, 3.2, 5.1, 5.2 |
| 4.2 | 上流エラーの透過的な返却 | 2.4, 5.3 |
| 4.3 | ネットワークエラー時の 504 エラー | 2.4, 5.1, 5.3 |
| 4.4 | 内部エラー時の 500 エラー | 2.4, 5.1 |
| 4.5 | 不完全な応答時の正規化エラー | 2.4, 5.1 |
| 5.1 | `/v1/chat/completions` エンドポイントの維持 | 3.2, 5.2 |
| 5.2 | モデル名に応じた自動経路選択 | 3.1, 3.2, 5.2 |
| 5.3 | 追加設定不要 | 3.2, 4.1, 5.2 |

---

## 実装の優先順位

1. **フェーズ 1: 基盤構築** (タスク 1, 2.1, 2.2)
   - 設定管理とOpenAI API通信の基礎を確立

2. **フェーズ 2: コア機能** (タスク 2.3, 2.4, 3.1, 3.2)
   - ストリーミング、エラーハンドリング、ルーティングロジックを実装

3. **フェーズ 3: 統合** (タスク 4.1)
   - サービス初期化と依存性注入の完成

4. **フェーズ 4: 検証** (タスク 5.1, 5.2, 5.3)
   - 包括的なテストによる品質保証

---

## 技術的な注意事項

### 既存コンポーネントとの連携
- `ModelRoutingService`: エイリアス解決は既存フローを維持
- `TransformService`: Antigravity ルートは既存の変換処理を使用
- `proxy-router.ts`: 分岐ロジックを追加、既存フローへの影響を最小化

### パフォーマンス目標
- 追加レイテンシ: < 50ms
- ストリーミング時のメモリ使用量: 一定（バッファリングなし）

### セキュリティ
- API キーのログ出力時マスク処理
- クライアントの `Authorization` ヘッダーを無視（上書き）
- レスポンスへの API キー露出防止
