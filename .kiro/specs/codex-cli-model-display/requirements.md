# 要件定義書: Adapter Configurable Model List

## プロジェクト概要（入力）
Codex Antigravity Adapter の `/v1/models` エンドポイントを改修し、ユーザーが設定ファイルや環境変数を通じて利用可能なモデルを追加・変更できるようにする。これまではソースコードにハードコードされたリストのみを提供していたが、Google Antigravity API のモデル一覧取得エンドポイントが存在しないことが判明したため、ユーザー主導の設定ベースのアプローチを採用する。

### 詳細要件ドラフト（EARS形式）

以下の要件定義は **EARS (Easy Approach to Requirements Syntax)** に基づいています。

#### 機能要件

* **When** `/v1/models` がリクエストされた場合, **システムは** 内部の固定モデルリストと、ユーザー設定された追加モデルリストをマージして返すこと。
* **When** ユーザーが環境変数 `ANTIGRAVITY_ADDITIONAL_MODELS` を設定している場合, **システムは** その値をパースし、モデルリストに追加すること。
* **When** ユーザーが設定ファイル（例: `models.json`）を配置している場合, **システムは** ファイルからモデル定義を読み込み、リストに統合すること（オプション）。
* **If** 同じモデルIDが固定リストとユーザー設定の両方に存在する場合, **システムは** ユーザー設定を優先して上書き、または重複を排除すること。

#### 技術制約

* **システムは** TypeScript と Hono フレームワークを使用して実装されること。
* **システムは** `src/config/antigravity.ts` または新しい設定モジュールでモデル設定を管理すること。
* **システムは** 環境変数のパースにおいて、JSON形式の文字列をサポートすること。

## 要件

### 要件1: モデル設定の読み込み
**目的:** ユーザーが再ビルドなしに新しいモデルIDを利用できるようにする。

#### 受入基準
1. **環境変数サポート**: `ANTIGRAVITY_ADDITIONAL_MODELS` 環境変数からカンマ区切り、またはJSON配列形式でモデルIDを読み込めること。
   - 例: `ANTIGRAVITY_ADDITIONAL_MODELS="gemini-1.5-pro-latest,claude-3-5-sonnet"`
2. **設定ファイルサポート** (推奨): アダプターのルートディレクトリ（または `.codex/`）にある `custom-models.json` (仮) を読み込めること。
3. **バリデーション**: 無効な形式の設定が与えられた場合、システムは警告ログを出力し、その設定を無視して起動を継続すること（クラッシュさせない）。

### 要件2: モデルリストの統合と提供
**目的:** `/v1/models` エンドポイントが網羅的なモデルリストを返すようにする。

#### 受入基準
1. **マージロジック**: `FIXED_MODEL_IDS` (組み込み) + `Additional Models` (設定) の和集合を返すこと。
2. **重複排除**: IDベースで重複を排除すること。
3. **レスポンス形式**: OpenAI互換の `Model` オブジェクト (`id`, `object="model"`, `created`, `owned_by`) の配列を含むJSONを返すこと。

### 要件3: ドキュメント更新
**目的:** ユーザーが新しい設定方法を理解できるようにする。

#### 受入基準
1. `README.md` に、新しい環境変数とモデル追加手順のセクションを追加すること。

## 実装ガイダンス

### 設定の優先順位
1. 環境変数 `ANTIGRAVITY_ADDITIONAL_MODELS`
2. 設定ファイル (もし実装する場合)
3. 組み込み `FIXED_MODEL_IDS`

※ シンプルさを優先し、まずは **環境変数のみ**、または **環境変数 + 簡易JSONファイル** 程度の実装から始めることを推奨する。

### 推奨実装パターン
- `src/config/models.ts` のような新しいモジュールを作成し、そこでモデルリストの構築ロジックを集約する。
- `ProxyRouter` はそのモジュールから `getAvailableModels()` を呼び出すだけにする。

## 成功指標
- ユーザーが環境変数を設定してアダプターを再起動するだけで、`/v1/models` に新しいモデルが表示され、CLIから選択可能になること。
