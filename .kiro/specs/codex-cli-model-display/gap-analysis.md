# ギャップ分析: codex-cli-model-display

## 1. 分析要約
本機能は、Codex CLIに対してアダプターが提供するモデル一覧を動的に構成可能にすることを目的としています。
現状のコードベースでは、モデルIDは `src/proxy/proxy-router.ts` 内にハードコードされており、外部からの変更を受け付ける仕組みが存在しません。
実装にあたっては、モデルリストの管理ロジックを構成モジュール（`src/config/models.ts`）として切り出し、環境変数および設定ファイルからの読み込み機能を実装する必要があります。既存のアーキテクチャ（Hono, TypeScript, Bun）に適合した形で、比較的低コストかつ低リスクで実装可能です。

## 2. 現状調査 (Current State)

### 対象資産
- **`src/proxy/proxy-router.ts`**:
  - `/v1/models` エンドポイントの実装が存在。
  - `FIXED_MODEL_IDS` 定数としてモデルリストがハードコードされている。
- **`src/config/`**:
  - 設定関連のロジックが配置されるディレクトリ。現在は `antigravity.ts` のみ存在。

### アーキテクチャと制約
- **設定管理**: 環境変数 (`process.env`) を直接参照する形が基本。
- **ファイルI/O**: Bun ランタイムを使用しているため、`Bun.file()` 等が利用可能。
- **依存性**: 外部ライブラリへの依存は最小限に抑えられている（標準API優先）。

## 3. 要件適合性分析 (Feasibility)

### 技術的要件とギャップ
| 要件 | 現状 | ギャップ | 判定 |
|---|---|---|---|
| **環境変数からのモデル追加** | 非対応 | `ANTIGRAVITY_ADDITIONAL_MODELS` のパース処理が必要 | 実装容易 |
| **設定ファイルからのモデル追加** | 非対応 | JSONファイルの読み込み処理が必要 | 実装容易 |
| **モデルリストの統合と重複排除** | 単一の固定リストのみ | 固定リストと動的リストのマージロジックが必要 | 実装容易 |
| **バリデーションとエラーハンドリング** | 不要（固定のため） | JSONパースエラー等を許容して動作継続する仕組みが必要 | 実装容易 |

### 技術的制約
- **パフォーマンス**: ファイル読み込みはサーバー起動時（またはリクエストごとだが、起動時キャッシュが望ましい）に行う必要がある。要件には「再ビルドなしに」とあるため、ホットリロードまたは再起動で反映されればよい。
- **セキュリティ**: 任意のJSONファイルを読み込むため、パスの制限やバリデーションが必要だが、ローカルアダプターであるためリスクは限定的。

## 4. 実装アプローチ案

### Option A: 既存ルーティングの拡張 (Extend Existing)
`src/proxy/proxy-router.ts` 内に直接、環境変数読み込みとファイル読み込みのロジックを追加する。

- **メリット**:
  - ファイル追加が不要。
  - 変更箇所が局所的。
- **デメリット**:
  - ルーターの責務（ルーティング）と設定の責務が混在する。
  - テストがしにくくなる（ファイルシステムへの依存がルーターに入る）。
  - `proxy-router.ts` が肥大化する。

### Option B: 設定モジュールの新設 (Create New Module) - **推奨**
`src/config/models.ts` を作成し、モデルリストの生成ロジックを集約する。

- **構成**:
  - `FIXED_MODEL_IDS` をこのファイルに移動。
  - `loadAdditionalModels()`: 環境変数とファイルから読み込み。
  - `getAvailableModels()`: 統合されたリストを返す公開関数。
- **メリット**:
  - **関心の分離**: ルーターはモデルリストの取得方法を知る必要がない。
  - **テスト容易性**: 設定ロジック単体でテストが可能。
  - **拡張性**: 将来的に別のソース（例: API経由）が増えても対応しやすい。
- **デメリット**:
  - ファイル数が1つ増える。

## 5. 実装の複雑さとリスク

- **工数 (Effort)**: **S (1-3 days)**
  - 既存パターンの適用で完結し、複雑な依存関係やアルゴリズムを含まないため。
- **リスク (Risk)**: **Low**
  - アーキテクチャへの変更はなく、機能追加のみであるため。既存機能への影響も限定的（`/v1/models` のレスポンス内容が変わるのみ）。

## 6. 推奨事項 (Next Steps)

1. **設計フェーズへの移行**: Option B（設定モジュールの新設）を採用して設計を行う。
2. **調査項目**:
   - `custom-models.json` の探索パス順序（カレントディレクトリ優先か、実行ファイル設置場所か）を明確にする。
   - JSONパースエラー時のログ出力方法（既存の `logging.ts` の活用）。
