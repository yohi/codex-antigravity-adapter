# Implementation Plan

## Overview
この実装計画は、`codex-cli-model-display` の要件定義と技術設計に基づいて生成されたタスクリストです。すべてのタスクは自然言語で記述され、実装の詳細（ファイルパス、メソッド名、型シグネチャなど）は `design.md` を参照してください。

---

- [ ] 1. プロジェクト基盤の準備と設定読み込み機能の実装
- [x] 1.1 モデル設定読み込みサービスの基本構造を構築
  - 環境変数と設定ファイルからモデルIDを読み込む機能を提供するサービスを作成
  - 読み込み結果として利用可能なモデル一覧とソースごとの件数を返す構造を定義
  - 起動時に一度だけ実行される非同期ロードメソッドを実装
  - _Requirements: 1.1, 1.2, 2.1_

- [x] 1.2 環境変数からモデルIDを読み込む機能を実装
  - JSON配列形式とカンマ区切り形式の両方に対応したパース処理を実装
  - 環境変数値の先頭文字が `[` であればJSON配列として解釈し、失敗時はCSV形式にフォールバックする
  - 空文字および空白のみのIDを除外するバリデーションを実装
  - パース失敗時やフォールバック時は警告ログを出力し、処理を継続する
  - _Requirements: 1.1, 1.3_

- [x] 1.3 設定ファイルからモデルIDを読み込む機能を実装
  - 固定パス（`cwd/custom-models.json` および `.codex/custom-models.json`）を順番に探索し、最初に見つかったファイルのみを採用する
  - 両方のパスにファイルが存在する場合は、先に見つかった方を採用し、他方を無視したことをinfoレベルでログ出力する
  - ファイルが存在しない場合はinfoレベルでログ出力し、該当ソースをスキップする
  - ファイル読み込みエラー（権限エラー、パースエラー）はerrorレベルでログ出力し、該当ソースをスキップする
  - 空白のみのIDを除外するバリデーションを実装
  - _Requirements: 1.2, 1.3_

- [x] 1.4 パストラバーサル保護とセキュリティ検証を実装
  - 設定ファイルのパス探索を固定パス（`cwd/custom-models.json` と `.codex/custom-models.json`）に限定する
  - `../` パターンや絶対パスが渡された場合、そのパスを拒否し、警告ログを出力する
  - シンボリックリンクを介したパストラバーサルを防ぐため、実パスの検証を実施する
  - _Requirements: 設計のセキュリティ要件_

- [ ] 2. モデルリストのマージと統合機能を実装
- [x] 2.1 複数ソースからのモデルIDを統合するマージロジックを実装
  - 固定モデル、ファイルモデル、環境変数モデルの3ソースを統合する
  - ソース処理順序（`env` → `file` → `fixed`）と優先順位（`env` が最高優先）を適用する
  - 重複するIDはfirst-seen winsルールで排除し、最も優先度の高いソースのモデルを保持する
  - マージ後のモデル一覧はすべてOpenAI互換形式（`id`, `object="model"`, `created`, `owned_by`）に変換する
  - ソースごとの読み込み件数（重複排除前）を集計し、返り値に含める
  - _Requirements: 2.1, 2.2_

- [x] 2.2 起動時にモデル設定を読み込み、エラーハンドリングを実装
  - アプリケーション起動フロー内で非同期にモデル設定を読み込む
  - 読み込み成功時は統合されたモデルカタログをログ出力（infoレベル、ソースごとの件数を含む）
  - 部分的なエラー（一部ソースの読み込み失敗）でもログ出力し、利用可能なソースでモデルカタログを構築する
  - 完全なエラー（すべてのソースで失敗）では警告ログを出力し、固定モデルのみを含むフォールバックカタログを生成する
  - _Requirements: 1.3, 2.1_

- [ ] 3. プロキシルーターと依存性注入を統合
- [ ] 3.1 プロキシアプリケーションにモデルカタログを注入するDI機構を実装
  - プロキシアプリケーション生成時にモデルカタログをオプショナルパラメータとして受け取る
  - モデルカタログが未指定の場合は、固定モデルのみを含むデフォルトカタログを生成する
  - 既存のテストや呼び出しコードへの影響を最小化し、段階的移行を可能にする
  - _Requirements: 2.1, 2.3_

- [ ] 3.2 `/v1/models` エンドポイントを更新し、注入されたモデルカタログを使用する
  - プロキシルーター内の `/v1/models` エンドポイントを修正し、固定リストへの直接参照を排除する
  - 注入されたモデルカタログからモデル一覧を取得し、OpenAI互換のレスポンス形式で返す
  - レスポンス形式は `{ object: "list", data: AvailableModel[] }` を維持する
  - モデルリストが空でもエラーを返さず、空の配列を含む正常なレスポンスを返す
  - _Requirements: 2.3_

- [ ] 4. テストスイートの実装
- [ ] 4.1 モデル設定読み込みサービスのユニットテストを作成
  - 環境変数（JSON配列形式）からモデルを読み込む正常系をテスト
  - 環境変数（カンマ区切り形式）からモデルを読み込む正常系をテスト
  - 設定ファイル（`custom-models.json`）からモデルを読み込む正常系をテスト
  - 環境変数、ファイル、固定モデルを統合してマージする正常系をテスト
  - 重複IDを優先順位（`env > file > fixed`）で排除する動作をテスト
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [ ] 4.2 エッジケースと異常系のユニットテストを作成
  - 環境変数JSONパース失敗時のCSVフォールバック動作をテスト
  - 環境変数カンマ区切りパース失敗（空文字のみ）の動作をテスト
  - 設定ファイル欠落時のスキップ動作をテスト
  - 設定ファイル不正JSON時のエラーログとスキップ動作をテスト
  - 設定ファイル空配列時の動作をテスト
  - 空白のみのIDがフィルタリングされることをテスト
  - 重複エントリ（同一ソース内、異なるソース間）の一意化動作をテスト
  - マージ順の競合（env=["a","b"], file=["b","c"], fixed=["c","d"]）の結果をテスト
  - _Requirements: 1.3, 2.1, 2.2_

- [ ] 4.3 環境変数パースロジックのユニットテストを作成
  - JSON配列形式の正常パースをテスト
  - カンマ区切り形式の正常パースをテスト
  - JSONパース失敗時のCSVフォールバック動作をテスト
  - 空文字と空白のみのIDが除外されることをテスト
  - _Requirements: 1.1_

- [ ] 4.4 重複排除とマージアルゴリズムのユニットテストを作成
  - IDベースの重複排除動作をテスト
  - 優先順位（`env > file > fixed`）に基づくfirst-seen winsルールをテスト
  - マージ順の安定性（処理順序が結果に影響しないこと）をテスト
  - _Requirements: 2.1, 2.2_

- [ ] 4.5 `/v1/models` エンドポイントの統合テストを作成
  - 環境変数からの追加モデルを含むレスポンスを検証
  - 設定ファイルからの追加モデルを含むレスポンスを検証
  - 無効設定（envエラー、fileエラー）でも固定モデルのみで応答することを検証
  - OpenAI互換のレスポンス形式（`object: "list"`, `data: AvailableModel[]`）を検証
  - _Requirements: 2.3_

- [ ] 4.6 プロキシアプリケーションのDI統合テストを作成
  - モデルカタログがプロキシアプリケーションに正しく注入されることを検証
  - モデルカタログ未指定時にデフォルトカタログが生成されることを検証
  - 既存のテストが正常に動作することを検証（後方互換性）
  - _Requirements: 2.1, 2.3_

- [ ] 4.7 セキュリティテストケースを作成
  - パストラバーサル攻撃（`../` パターン、絶対パス）が防止されることを検証
  - シンボリックリンクを介したパストラバーサルが防止されることを検証
  - エラーログにシークレットやAPIキーが含まれないことを検証
  - モデルIDに類似したシークレット（例: `sk-proj-...`）が誤って設定された場合のマスキングを検証
  - _Requirements: 設計のセキュリティ要件_

- [ ] 5. ドキュメント更新とエンドツーエンド検証
- [ ] 5.1 READMEに新しい環境変数とモデル追加手順を追加
  - 環境変数 `ANTIGRAVITY_ADDITIONAL_MODELS` の使い方（JSON配列形式とカンマ区切り形式）を説明
  - 設定ファイル（`custom-models.json` および `.codex/custom-models.json`）の使い方を説明
  - 設定の優先順位（env > file > fixed）を明記
  - 使用例とサンプル設定を提供
  - _Requirements: 3.1_

- [ ] 5.2 エンドツーエンドの動作確認を実施
  - Codex CLIから `/v1/models` を取得し、追加モデルが表示されることを確認
  - 設定ファイルを更新してアダプターを再起動し、新しいモデルが反映されることを確認
  - 無効な設定（不正なJSON、パストラバーサル試行）でも起動が継続することを確認
  - _Requirements: 全要件の統合検証_
