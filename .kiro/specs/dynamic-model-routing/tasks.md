# 実装計画

## タスク概要
本実装計画は、動的モデルルーティング機能の開発タスクを定義する。各タスクは要件と設計ドキュメントに基づき、段階的に機能を構築する。

---

- [ ] 1. エイリアス設定読み込み機能の実装
- [x] 1.1 ModelAliasConfigService の基本構造を実装する
  - エイリアスマップを保持する内部状態を定義する
  - getTargetModel、hasAlias、listAliases、getAll メソッドのインターフェースを実装する
  - ファクトリ関数 createModelAliasConfigService の骨格を作成する
  - _Requirements: 1.1, 1.4_

- [x] 1.2 設定ファイル読み込みとパース機能を実装する
  - Bun.file を使用して model-aliases.json を読み込む
  - JSON パースエラーを捕捉し、警告ログを出力する
  - ファイル不存在時に情報ログを出力し、空マップで継続する
  - _Requirements: 1.2, 1.3_

- [x] 1.3 エイリアス設定のスキーマ検証を実装する
  - AliasTagSchema でエイリアスタグ形式（@[a-zA-Z][a-zA-Z0-9_-]*）を検証する
  - モデルIDが空でない文字列であることを検証する
  - 無効なエントリをスキップし、警告ログを出力する
  - _Requirements: 1.4_

- [x] 1.4 パストラバーサル防止機能を実装する
  - isUnsafePath 関数で相対パス（..）と絶対パスを検出する
  - realpath でシンボリックリンクを解決し、プロジェクトルート内を検証する
  - パス安全性違反時に警告ログを出力し、空マップで継続する
  - _Requirements: 1.1, 1.2_

- [x] 1.5 設定読み込みの単体テストを作成する
  - 正常な設定ファイルの読み込みをテストする
  - ファイル不存在時の動作をテストする
  - 無効JSON時の動作をテストする
  - 無効エントリのスキップと警告ログをテストする
  - パス安全性チェック（..、絶対パス、シンボリックリンク）をテストする
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 2. エイリアス検出ユーティリティの実装
- [x] 2.1 detectAlias 純粋関数を実装する
  - 先頭が @ でない場合に即座に非検出を返す
  - 既知エイリアスに完全一致し、直後が空白または終端の場合に検出する
  - エイリアスと直後の空白1文字を除去した残りコンテンツを返す
  - 非検出時は入力文字列の参照をそのまま返す
  - _Requirements: 2.3, 4.1, 4.2, 5.2_

- [x] 2.2 detectAlias の単体テストを作成する
  - 先頭が @ でない場合の非検出をテストする
  - 既知エイリアスに完全一致かつ直後が空白の場合の検出をテストする
  - 既知エイリアスに完全一致かつ直後が終端の場合の検出をテストする
  - 部分一致（@fast に対して @faster）の非検出をテストする
  - 未知エイリアス（@unknown）の非検出をテストする
  - エイリアス除去後の残りコンテンツの正確性をテストする
  - _Requirements: 2.3, 4.1, 4.2, 5.2_

- [ ] 3. ModelRoutingService の実装
- [x] 3.1 ModelRoutingService の基本構造を実装する
  - route メソッドのインターフェースを実装する
  - RoutingResult 型を定義し、返却する
  - ファクトリ関数 createModelRoutingService の骨格を作成する
  - _Requirements: 2.1, 3.1_

- [x] 3.2 最新ユーザーメッセージの検出機能を実装する
  - メッセージ配列を末尾から走査して最新のユーザーメッセージを探す
  - ユーザーメッセージが存在しない場合はパススルーする
  - 検出したユーザーメッセージの文字列コンテンツを取得する
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 3.3 ルーティング決定とモデル置換を実装する
  - detectAlias を呼び出してエイリアスを検出する
  - 検出されたエイリアスから ModelAliasConfigService でターゲットモデルIDを取得する
  - ターゲットモデルIDが存在する場合にリクエストの model を置き換える
  - 未知エイリアスの場合は元のモデル値を保持する
  - _Requirements: 3.1, 3.2_

- [x] 3.4 プロンプトサニタイズ機能を実装する
  - エイリアス検出時に detectAlias から得た remainingContent で元のメッセージを置き換える
  - エイリアス除去後に空文字列になった場合もそのまま保持する
  - エイリアスを含んだユーザーメッセージのみを変更し、他のメッセージは不変とする
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3.5 ルーティングログとエラーハンドリングを実装する
  - ルーティング適用時に元のモデル、エイリアス、ターゲットモデルをデバッグレベルで記録する
  - route メソッド内の例外をキャッチし、パススルーで継続する
  - 例外発生時にエラーログを出力する
  - _Requirements: 3.3, 5.1_

- [ ] 3.6 ModelRoutingService の単体テストを作成する
  - エイリアス検出時のモデル置換をテストする
  - 未知エイリアス時のパススルーをテストする
  - ユーザーメッセージ不在時のパススルーをテストする
  - 最後のユーザーメッセージのみが変更されることをテストする
  - 例外発生時のパススルーをテストする
  - _Requirements: 2.1, 2.2, 3.1, 3.2, 4.3, 4.4, 5.1_

- [ ] 4. プロキシルータへの統合
- [ ] 4.1 proxy-router.ts にルーティング呼び出しを追加する
  - ChatCompletionRequestSchema.safeParse 後にルーティングサービスを呼び出す位置を確認する
  - modelRoutingService.route を呼び出し、RoutingResult を取得する
  - ルーティング後のリクエストを transformService.handleCompletion に渡す
  - _Requirements: 2.4, 6.1_

- [ ] 4.2 CreateProxyAppOptions にルーティングサービスを追加する
  - modelRoutingService を optional プロパティとして追加する
  - ルーティングサービスが存在しない場合のフォールバック処理を実装する
  - 既存のスキーマ検証と変換パイプラインを保護する
  - _Requirements: 6.4_

- [ ] 4.3 プロキシルータ統合の単体テストを作成する
  - スキーマ検証後にルーティングが呼ばれることをテストする
  - ルーティング後に transformService が呼ばれることをテストする
  - ルーティングサービスが存在しない場合のフォールバックをテストする
  - _Requirements: 2.4, 6.1, 6.4_

- [ ] 5. アプリケーション起動時の統合
- [ ] 5.1 main.ts でエイリアス設定を読み込む
  - startApplication 関数で ModelAliasConfigService をロードする
  - ロードした設定サービスを createAppContext に注入する
  - エイリアス設定のロードエラーをログに記録する
  - _Requirements: 1.1, 1.2_

- [ ] 5.2 createAppContext にルーティングサービスを追加する
  - ModelRoutingService を作成し、ModelAliasConfigService を依存として注入する
  - ルーティングサービスを createProxyApp に渡す
  - アプリケーションコンテキストの型定義を更新する
  - _Requirements: 1.1, 3.1_

- [ ] 5.3 統合テストを作成する
  - ModelAliasConfigService が createAppContext から注入されることをテストする
  - ルーティング有無に関わらず正常にレスポンスが返ることをテストする
  - エイリアス設定の依存注入が正しく動作することをテストする
  - _Requirements: 全要件_

- [ ] 6. エンドツーエンドテストと検証
- [ ] 6.1 正常系エンドツーエンドテストを作成する
  - エイリアスを含むリクエストで正しいモデルにルーティングされることをテストする
  - エイリアスがプロンプトから除去されることをテストする
  - エイリアスなしのリクエストが変更されないことをテストする
  - _Requirements: 2.3, 3.1, 4.1, 5.1_

- [ ] 6.2 異常系エンドツーエンドテストを作成する
  - 未知エイリアスでパススルーされることをテストする
  - 無効な設定ファイルでも起動できることをテストする
  - ルーティング処理で例外が発生してもパススルーされることをテストする
  - _Requirements: 1.2, 1.3, 3.2, 5.1_

- [ ] 6.3 プロパティテストを作成する
  - 非検出時に remainingContent が content と同一参照であることをテストする
  - 検出時に content がエイリアスで始まることをテストする
  - messages 配列の他の要素が変更されないことをテストする
  - model 以外のリクエストフィールドが不変であることをテストする
  - _Requirements: 4.4, 5.3_

- [ ] 7. ドキュメントとサンプル設定の作成
- [ ] 7.1 model-aliases.json のサンプルファイルを作成する
  - プロジェクトルートに model-aliases.json.example を作成する
  - fast、think、pro などの一般的なエイリアスを含める
  - コメント付きで使用方法を説明する
  - _Requirements: 1.1, 1.4_

- [ ] 7.2 機能の使用方法を README に追加する
  - 動的モデルルーティング機能の概要を記述する
  - エイリアス設定ファイルの配置方法を説明する
  - プロンプト内でのエイリアス使用例を示す
  - _Requirements: 全要件_

---

## タスク完了基準
- 全てのテストが成功すること
- コードカバレッジが既存レベルを維持すること
- 既存機能が影響を受けないこと（リグレッションテスト）
- TypeScript の型チェックがエラーなく完了すること
